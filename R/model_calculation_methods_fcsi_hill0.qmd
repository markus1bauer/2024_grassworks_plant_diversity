---
title: "GRASSWORKS Project: Vegetation diversity analysis"
subtitle: "Question 1: Reference sites: Response variable: FCSi (Index of Favourable Conservation Status)"
author: "<b>Markus Bauer</b>"
date: "<b>`r format(Sys.time(), '%Y-%m-%d')`</b>"
output:
  github_document:
    toc: true
    toc_depth: 3
    dev: png
    fig_width: 7
    fig_height: 5
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE
  )
```

<br/>
<br/>
<b>Markus Bauer</b>

Technichal University of Munich, TUM School of Life Sciences, Chair of
Restoration Ecology, Emil-Ramann-Stra√üe 6, 85354 Freising, Germany

[markus1.bauer\@tum.de](mailto:markus1.bauer@tum.de)

ORCiD ID: [0000-0001-5372-4174](https://orcid.org/0000-0001-5372-4174)
<br>
[Google Scholar](https://scholar.google.de/citations?user=oHhmOkkAAAAJ&hl=de&oi=ao)
<br>
GitHub: [markus1bauer](https://github.com/markus1bauer)

# Preparation

Protocol of data exploration (Steps 1-8) used from Zuur et al. (2010) Methods Ecol Evol [DOI: 10.1111/2041-210X.12577](https://doi.org/10.1111/2041-210X.12577)



#### Packages

```{r libraries, message = FALSE}
library(here)
library(tidyverse)
library(ggbeeswarm)
library(patchwork)
library(glmmTMB)
library(DHARMa)
library(emmeans)
```

```{r echo = FALSE}
rm(list = ls())
```

#### Load data

```{r load-data}
sites <- read_csv(
  here("data", "processed", "data_processed.csv"),
  col_names = TRUE, na = c("na", "NA", ""), col_types = cols(
    .default = "?"
  )) %>%
  mutate(rest.meth = fct_relevel(rest.meth, "cus", "mga", "res", "dih")) %>%
  rename(y = fcsi.hill.0)
```

# Statistics

## Data exploration

### Means and deviations

```{r means}
Rmisc::CI(sites$y, ci = .95)
median(sites$y)
sd(sites$y)
quantile(sites$y, probs = c(0.05, 0.95), na.rm = TRUE)
```

### Graphs of raw data (Step 2, 6, 7)

```{r data-exploration, echo = FALSE, warning = FALSE, message = FALSE}
plot1 <- ggplot(sites, aes(x = hydrology, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Hydrology")
plot2 <- ggplot(sites, aes(x = region, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Region")
plot3 <- ggplot(sites, aes(x = rest.meth, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Restoration methods")
plot4 <- ggplot(sites, aes(x = rest.age.std, y = (y))) +
  geom_point() +  geom_smooth(method = "lm") +
  labs(title = "Restoration age (standardized)")
(plot1 + plot2) / (plot3 + plot4)
plot1 <- ggplot(sites, aes(x = land.use.hist, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Land-use history")
plot2 <- ggplot(sites, aes(x = site.type, y = y)) +
  geom_quasirandom(color = "grey") + geom_boxplot(fill = "transparent") +
  labs(title = "Site type")
plot1 + plot2
```

### Outliers, zero-inflation, transformations? (Step 1, 3, 4)

```{r outliers, echo = FALSE, warning = FALSE}
sites %>%
  count(rest.meth)
plot1 <- ggplot(sites, aes(x = rest.meth, y = y)) +
  geom_quasirandom()
plot2 <- ggplot(sites, aes(x = y)) +
  geom_histogram(binwidth = 0.03)
plot3 <- ggplot(sites, aes(x = y)) +
  geom_density()
plot4 <- ggplot(sites, aes(x = log(y))) +
  geom_density()
(plot1 + plot2) / (plot3 + plot4)
```

### Check collinearity part 1 (Step 5)

Exclude r > 0.7
<br>
Dormann et al. 2013 Ecography [DOI: 10.1111/j.1600-0587.2012.07348.x](https://doi.org/10.1111/j.1600-0587.2012.07348.x)

--> only restoration age continuous

## Models

Only here you have to modify the script to compare other models

```{r load-models, collapse = TRUE}
load(file = here("outputs", "models", "model_methods_fcsi_hill0_full.Rdata"))
load(file = here("outputs", "models", "model_methods_fcsi_hill0_20y.Rdata"))
m_1 <- data_model_fcsihill0
m_2 <- data_model_fcsihill0_20y
```

```{r formulas, collapse = TRUE}
m_1@call
m_2@call
```

## Model check

### DHARMa

```{r dharma_all, collapse = TRUE, warning = FALSE}
simulation_output_1 <- simulateResiduals(m_1, plot = TRUE)
simulation_output_2 <- simulateResiduals(m_2, plot = TRUE)
```

```{r dharma_single, collapse = TRUE, fig.height = 3, fig.width = 4.5}
plotResiduals(simulation_output_1$scaledResiduals, sites$region)
plotResiduals(simulation_output_2$scaledResiduals, sites$region)
plotResiduals(simulation_output_1$scaledResiduals, sites$hydrology)
plotResiduals(simulation_output_2$scaledResiduals, sites$hydrology)
plotResiduals(simulation_output_1$scaledResiduals, sites$site.type)
plotResiduals(simulation_output_2$scaledResiduals, sites$site.type)
plotResiduals(simulation_output_1$scaledResiduals, sites$rest.meth)
plotResiduals(simulation_output_2$scaledResiduals, sites$rest.meth)
plotResiduals(simulation_output_1$scaledResiduals, sites$land.use.hist)
plotResiduals(simulation_output_2$scaledResiduals, sites$land.use.hist)
plotResiduals(simulation_output_1$scaledResiduals, sites$rest.age.std)
plotResiduals(simulation_output_2$scaledResiduals, sites$rest.age.std)
```

### Check collinearity part 2 (Step 5)

Remove VIF > 3 or > 10
<br>
Zuur et al. 2010 Methods Ecol Evol [DOI: 10.1111/j.2041-210X.2009.00001.x](https://doi.org/10.1111/j.2041-210X.2009.00001.x)

```{r vif}
car::vif(m_1)
car::vif(m_2)
```

## Model comparison

### <i>R</i><sup>2</sup> values

```{r r2, collapse = TRUE}
MuMIn::r.squaredGLMM(m_1)
MuMIn::r.squaredGLMM(m_2)
```

### AICc

Use AICc and not AIC since ratio n/K < 40
<br>
Burnahm & Anderson 2002 p. 66
ISBN: 978-0-387-95364-9

```{r aicc, collapse = TRUE}
MuMIn::AICc(m_1, m_2) %>%
  arrange(AICc)
```

## Predicted values

### Summary table

```{r summary}
summary(m_2)
```

### Forest plot

```{r predicted_values, fig.height = 6}
dotwhisker::dwplot(
  list(m_1, m_2),
  ci = 0.95,
  show_intercept = FALSE,
  vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2)) +
  xlim(-0.3, 0.35) +
  theme_classic()
```

### Effect sizes

Effect sizes of chosen model just to get exact values of means etc. if
necessary.

```{r effect-sizes, message = FALSE}
(emm <- emmeans(
  m_2,
  revpairwise ~ rest.meth,
  type = "response"
  ))
plot(emm, comparison = TRUE)
```

# Session info

```{r session-info, echo = FALSE}
sessionInfo()
```
